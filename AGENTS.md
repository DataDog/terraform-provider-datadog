# Datadog Terraform Provider

For setup, building, and contribution guidelines, read [DEVELOPMENT.md](./DEVELOPMENT.md) first.

## Critical Rules

### NEVER Use Raw Go Commands for Testing

```bash
# ALWAYS use Makefile targets:
make test                                              # Unit tests
RECORD=false TESTARGS="-run TestName" make testacc     # Acceptance tests

# Recording modes for acceptance tests:
# RECORD=false  - Use cassettes (fast, default)
# RECORD=true   - Record new cassettes
# RECORD=none   - Live API only
```

Raw `go test` bypasses `gotestsum` and test infrastructure.

### Testing Details

For full testing details (unit vs acceptance, RECORD modes, examples), see [TESTING.md](./TESTING.md). The Claude test runner skill also includes expanded test-running guidance.

### ALWAYS Add Schema Descriptions

All schema attributes MUST have `Description` fields - required for `make docs` generation.

## Project Structure

- `datadog/fwprovider/` - Framework resources, search here for new resource patterns
- `datadog/*.go` - SDKv2 resources (legacy), do NOT use for new resources
- `datadog/internal/` - Shared utilities: validators, customtypes, fwutils, planmodifiers
- `datadog/tests/` - Acceptance tests
- `examples/` - HCL examples used by docs generation
- `docs/` - Auto-generated by `make docs`, do NOT edit directly

### Generated Documentation Exceptions

Some docs are manually maintained and excluded from auto generation. Check `scripts/generate-docs.sh` for the current `exclude_files` list before editing any `docs/` files.

## Code Patterns

- ALWAYS search `datadog/fwprovider/` for existing patterns before implementing new ones
- Use Blocks, not Nested Attributes for complex structures
- Avoid ObjectType (breaks docs generation - no field description support)

## Quality Gates

### Quick Checks (before any commit)

- [ ] `make fmtcheck` passes
- [ ] `make test` passes

### Full Validation (before push)

- [ ] `make docs && make check-docs` passes
- [ ] `make vet` and `make errcheck` pass
- [ ] Acceptance tests pass with `RECORD=none` for changed resources
- [ ] No sensitive data in logs or errors

## PR Labels

- Changelog: `improvement`, `feature`, `bugfix`, `note`, or `no-changelog`
- Title prefix: `[datadog_resource_name] Description`

---

## Dashboard Resource: FieldSpec Bidirectional Mapping System

`datadog/dashboardmapping/` contains a mapping-driven architecture for the v2 dashboard
and powerpack resources. Each field is declared **once** as a `FieldSpec`, which drives
HCL↔JSON serialization, schema registration, and docs generation.

- `datadog_dashboard` / `datadog_powerpack` — **Original** SDKv2 resources (maintained for backward compatibility)
- `datadog_dashboard_v2` / `datadog_powerpack_v2` — **FieldSpec engine** resources (all new development)

### Package layout

| File | Contents |
|---|---|
| `engine.go` | `FieldSpec`/`WidgetSpec`/`FormulaRequestConfig` types, build/flatten engine, widget dispatch, post-processing hooks |
| `field_groups.go` | Reusable `[]FieldSpec` groups (widget-scoped), named after OpenAPI `$ref` schemas |
| `field_groups_dashboard.go` | Dashboard top-level field groups (NOT shared with widget specs) |
| `schema_gen.go` | `FieldSpecToFWAttribute`, `FieldSpecsToFWSchema`, `WidgetSpecToFWBlock` — generate framework schema from FieldSpec |
| `widgets.go` | All `WidgetSpec` declarations and `allWidgetSpecs` registry |

### Key principles

- Adding a field = adding one `FieldSpec` entry. Schema generation (`FieldSpecToFWAttribute`) and JSON mapping are automatic.
- Reusable field groups in `field_groups.go` are named after their OpenAPI schema counterparts (e.g. `logQueryDefinitionFields` → `LogQueryDefinition`).
- HCL uses **singular** block names; JSON uses **plural** keys. Set `JSONKey` to bridge the gap.
- `OmitEmpty: true` for optional fields; cassette recordings are the ground truth.
- `TypeOneOf` handles discriminated `oneOf` unions — see `widgetNumberFormatFields.unit` for an example.
- Widget specs registered in `allWidgetSpecs` get schema and state converters generated automatically — no changes to `fwprovider/resource_datadog_dashboard_v2.go` needed.
