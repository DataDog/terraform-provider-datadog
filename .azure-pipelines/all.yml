name: IntegrationTests
trigger:
    batch: false
    branches:
        include:
            - master
pr:
    branches:
        include:
            - master

schedules:
    - cron: "0 */12 * * *"
      displayName: Scheduled CI run every 12 hours
      always: true
      branches:
          include:
              - master

resources:
    containers:
        - container: datadog-agent
          image: datadog/agent:latest
          ports:
              - 8126:8126
          env:
              DD_API_KEY: $(ddAPIKey)
              DD_HOSTNAME: "none"
              DD_INSIDE_CI: "true"

jobs:
    - job: IntegrationTests
      pool:
          vmImage: "Ubuntu-20.04"
      container:
          image: golang:1.16
      services:
          datadog-agent: datadog-agent
      steps:
          - script: make testacc
            displayName: Run integration tests
            env:
                RECORD: "none"
                CI: "true"
                DD_AGENT_HOST: datadog-agent
                DD_PROFILER_API_KEY: $(ddAPIKey)
                DD_TEST_CLIENT_API_KEY: $(datadogAPIKey)
                DD_TEST_CLIENT_APP_KEY: $(datadogAPPKey)
                DD_ENV: prod
                DD_SERVICE: terraform-provider-datadog
                DD_VERSION: $(Build.SourceVersion)
                DD_TAGS: "team:integration-tools-and-libraries"
