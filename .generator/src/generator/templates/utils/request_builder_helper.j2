{%- macro baseRequestBuilder(name, schema, baseSetter, baseAccessor, required=False) %}
    {%- if schema|is_primitive %}
        {{- typePrimitiveRequestBuilder(name, schema, baseSetter, baseAccessor, required=required) }}
    {%- elif schema.type == "object" %}
        {{- typeObjectRequestBuilder(name, schema, baseSetter, baseAccessor, required=required) }}
    {%- elif schema.type == "array" %}
        {{- typeArrayRequestBuilder(name, schema, baseSetter, baseAccessor, required=required) }}
    {%- endif %}
{%- endmacro %}

{%- macro requestBuilder(schema, baseSetter, baseAccessor) %}
    {%- set primitiveAttr, primitiveArrAttr, nonPrimitiveListAttr, nonPrimitiveObjAttr = schema|tf_sort_properties_by_type %}

    {%- for attr, attrSchema in primitiveAttr.items() %}
    {%- set isRequired = attr in schema.get("required", []) %}
    {{- baseRequestBuilder(attr, attrSchema, baseSetter, baseAccessor, required=isRequired) }}
    {%- endfor %}

    {%- for attr, attrSchema in primitiveArrAttr.items() %}
    {%- set isRequired = attr in schema.get("required", []) %}
    {{ baseRequestBuilder(attr, attrSchema, baseSetter, baseAccessor, required=isRequired) }}
    {%- endfor %}

{%- endmacro %}

{%- macro typePrimitiveRequestBuilder(name, schema, baseSetter, baseAccessor, required=False) %}
    {{ baseSetter }}.{{ name|camel_case }} = {% if not required %}datadog.Ptr{{ get_terraform_schema_type(schema) }}({% endif %}{{ baseAccessor }}.{{ name|camel_case }}.Value{{ get_terraform_schema_type(schema) }}(){% if not required %}){% endif %}
{%- endmacro %}

{%- macro typeObjectRequestBuilder(name, schema, baseAccessor="resp", required=False) %}
{%- endmacro %}

{%- macro typeArrayRequestBuilder(name, schema, baseSetter, baseAccessor, required=False) %}
    {%- set itemSchema = schema.get("items") %}
    {%- if itemSchema|is_primitive %}
    	var {{ name|variable_name }} []{{ get_type(itemSchema) }}
    	diags.Append({{ baseAccessor }}.{{ name|camel_case }}.ElementsAs(ctx, &{{ name|variable_name }}, false)...)
    	{{ baseSetter }}.{{ name|camel_case }} = {{ name|variable_name }}
    {%- else %}

    {%- endif %}
{%- endmacro %}

{%- macro requestBaseFunc(name, funcName, parameterBodySchema) %}
func (r *{{ name|camel_case }}Resource) {{ funcName }}(ctx context.Context, plan *{{ name|camel_case }}Model) (*datadog{{ version }}.{{ get_type(parameterBodySchema) }}, diag.Diagnostics) {
    diags := diag.Diagnostics{}

	{%- if parameterBodySchema|is_json_api %}
	{%- set jsonAttributeSchema = json_api_attributes_schema(parameterBodySchema) %}
    {%- set parameterBodyDataSchema = parameterBodySchema.properties.data %}
    {%- set isDataRequired = "data" in parameterBodySchema.get("required", []) %}
	attributes := datadog{{ version }}.New{{ get_type(jsonAttributeSchema) }}WithDefaults()

    {{ requestBuilder(jsonAttributeSchema, "attributes", "plan") }}

    req := datadogV2.New{{ get_type(parameterBodySchema) }}WithDefaults()
    req.Data = {% if isDataRequired %}*{% endif %}datadogV2.New{{ get_type(parameterBodyDataSchema) }}WithDefaults()
    req.Data.SetAttributes(*attributes)

    {%- else %}
    {{ requestBuilder(parameterBodySchema, "req", "plan") }}
    {%- endif %}

	return req, diags
}
{%- endmacro %}
